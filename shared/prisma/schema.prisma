generator client_js {
  provider      = "prisma-client-js"
  output        = "../../web/node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

generator client_py {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// MULTI-TENANT MODELS
// ===========================================

// Organization (Tenant) model
model Organization {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  isPersonal Boolean  @default(false) // True for personal workspaces created on signup
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // If this is a personal org, link to the owning user (for cascade delete)
  owner user? @relation("PersonalOrganization")

  memberships      Membership[]
  projects         Project[]
  datasets         Dataset[]
  experiments      Experiment[]
  evals            Eval[]
  traceSessions    TraceSession[]
  traces           Trace[]
  logs             Log[]
  apiKeys          ApiKey[]
  invitations      Invitation[]
  auditLogs        AuditLog[]
  complianceChecks ComplianceCheck[]

  @@map("organization")
}

// Membership - User-Organization relationship with roles
model Membership {
  id        String   @id @default(cuid())
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId         String
  user           user         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("membership")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ===========================================
// PROJECT MODE ENUMS
// ===========================================

enum ProjectMode {
  EVALS // Evaluation and testing
  OBSERVABILITY // Traces and logs
  MONITORING // Real-time monitoring
}

// ===========================================
// COMPLIANCE ENUMS
// ===========================================

enum ComplianceFramework {
  ABC // Evaris ABC compliance framework
  SOC2 // SOC2 compliance
  GDPR // GDPR data protection
  EU_AI_ACT // EU AI Act requirements
}

enum ComplianceStatus {
  COMPLIANT // All checks passed
  WARNING // Minor issues detected
  VIOLATION // Critical compliance violation
  UNCHECKED // Not yet evaluated
}

// ===========================================
// OBSERVATION TYPE ENUMS
// ===========================================

enum ObservationType {
  SPAN // Generic span (function call, operation)
  GENERATION // LLM generation (with token tracking)
  EVENT // Point-in-time event
}

enum ObservationLevel {
  DEBUG // Debug level observation
  DEFAULT // Normal operation
  WARNING // Warning - something may be wrong
  ERROR // Error occurred
}

// ===========================================
// API KEYS FOR PROGRAMMATIC ACCESS
// ===========================================

model ApiKey {
  id          String      @id @default(cuid())
  name        String
  keyHash     String      @unique // SHA-256 hash of the actual key
  keyPrefix   String // First 8 chars for identification (e.g., "evaris_sk_abc12345...")
  permissions ApiKeyScope @default(READ_WRITE)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Creator for audit purposes
  createdById String?
  createdBy   user?   @relation("ApiKeyCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([keyHash])
  @@index([keyPrefix])
  @@map("api_key")
}

enum ApiKeyScope {
  READ_ONLY
  READ_WRITE
  ADMIN
}

// ===========================================
// TEAM INVITATIONS
// ===========================================

model Invitation {
  id        String           @id @default(cuid())
  email     String
  role      Role             @default(MEMBER)
  status    InvitationStatus @default(PENDING)
  token     String           @unique // Unique token for accepting invitation
  expiresAt DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Belongs to organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Inviter for audit purposes
  invitedById String?
  invitedBy   user?   @relation("InvitationSender", fields: [invitedById], references: [id], onDelete: SetNull)

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([token])
  @@index([email])
  @@map("invitation")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ===========================================
// AUDIT LOGS
// ===========================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String // e.g., "project.created", "eval.deleted", "member.invited"
  entityType String // e.g., "project", "eval", "dataset", "member"
  entityId   String? // ID of the affected entity
  metadata   Json     @default("{}") // Additional context (old values, new values, etc.)
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actor who performed the action
  userId String?
  user   user?   @relation("AuditLogActor", fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@map("audit_log")
}

// ===========================================
// BETTER AUTH MODELS
// ===========================================

// Better Auth - User model
model user {
  id            String   @id
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Personal organization - created on signup, deleted when user is deleted
  // This is the user's default workspace that cannot be deleted independently
  personalOrganizationId String?       @unique
  personalOrganization   Organization? @relation("PersonalOrganization", fields: [personalOrganizationId], references: [id], onDelete: SetNull)

  sessions           session[]
  accounts           account[]
  memberships        Membership[]
  createdProjects    Project[]    @relation("ProjectCreator")
  createdExperiments Experiment[] @relation("ExperimentCreator")
  createdEvals       Eval[]       @relation("EvalCreator")
  createdApiKeys     ApiKey[]       @relation("ApiKeyCreator")
  sentInvitations    Invitation[]   @relation("InvitationSender")
  auditLogs          AuditLog[]     @relation("AuditLogActor")
  uploadedDatasetFiles DatasetFile[] @relation("DatasetFileUploader")

  @@map("user")
}

// Better Auth - Session model
model session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// Better Auth - Account model (for OAuth providers)
model account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

// Better Auth - Verification model (for email verification, password reset, etc.)
model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ===========================================
// APPLICATION MODELS
// ===========================================

// Projects for organizing evaluations, observability, and monitoring
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  modes       ProjectMode[] @default([EVALS]) // Multi-mode support
  settings    Json          @default("{}") // Project-specific settings (retention, alerting, etc.)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Creator for audit purposes
  createdById String?
  createdBy   user?   @relation("ProjectCreator", fields: [createdById], references: [id], onDelete: SetNull)

  experiments      Experiment[]
  evals            Eval[]
  datasets         Dataset[]
  traces           Trace[]
  logs             Log[]
  traceSessions    TraceSession[]
  complianceChecks ComplianceCheck[]

  @@index([organizationId])
  @@index([createdById])
  @@index([organizationId, createdAt])
}

// Datasets for evaluation
model Dataset {
  id          String  @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Files in this dataset
  files DatasetFile[]
  evals Eval[]

  @@index([organizationId])
  @@index([projectId])
  @@index([organizationId, createdAt])
  @@index([projectId, createdAt])
}

model DatasetFile {
  id        String   @id @default(cuid())
  name      String // Original filename
  format    DatasetFormat @default(JSONL)
  itemCount Int      @default(0) // Number of items/rows in file
  filePath  String // Storage path for download
  fileSize  Int // Size in bytes
  mimeType  String? // MIME type
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Who uploaded this file
  uploadedById String?
  uploadedBy   user?   @relation("DatasetFileUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  // Parent dataset
  datasetId String
  dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
  @@map("dataset_file")
}

enum DatasetFormat {
  JSON
  JSONL
  CSV
  PARQUET
}

// Experiments for versioning and A/B comparison
model Experiment {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Configuration snapshot at experiment time
  config Json @default("{}") // Prompt, model, parameters, etc.

  // Versioning support
  version  Int          @default(1)
  parentId String?
  parent   Experiment?  @relation("ExperimentVersions", fields: [parentId], references: [id], onDelete: SetNull)
  children Experiment[] @relation("ExperimentVersions")

  // Experiment metadata
  hypothesis String? // What are we testing?
  conclusion String? // What did we learn?
  tags       String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Creator for audit purposes
  createdById String?
  createdBy   user?   @relation("ExperimentCreator", fields: [createdById], references: [id], onDelete: SetNull)

  evals Eval[]

  @@index([organizationId])
  @@index([projectId])
  @@index([parentId])
  @@map("experiment")
}

// Evaluation runs
model Eval {
  id       String     @id @default(cuid())
  name     String
  status   EvalStatus @default(PENDING)
  total    Int? // Total test cases
  passed   Int? // Passed test cases
  failed   Int? // Failed test cases
  accuracy Float? // Pass rate (0.0 - 1.0)
  summary  Json? // Detailed summary with per-metric stats
  error    String? // Error message if evaluation failed
  metadata Json       @default("{}")

  // Progress tracking for real-time updates
  progress    Int       @default(0) // Current progress (0-100)
  startedAt   DateTime? // When evaluation started
  completedAt DateTime? // When evaluation finished
  durationMs  Int? // Total duration in milliseconds
  totalCost   Float? // Total cost in USD (for LLM-as-judge)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Creator for audit purposes
  createdById String?
  createdBy   user?   @relation("EvalCreator", fields: [createdById], references: [id], onDelete: SetNull)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Optional experiment - for versioning and comparison
  experimentId String?
  experiment   Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)

  // Baseline comparison - compare this eval against a previous one
  baselineEvalId String?
  baselineEval   Eval?   @relation("EvalComparison", fields: [baselineEvalId], references: [id], onDelete: SetNull)
  comparedEvals  Eval[]  @relation("EvalComparison")

  // Optional dataset - inline assessments via SDK don't require a stored dataset
  datasetId String?
  dataset   Dataset? @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  // Test results for this evaluation
  testResults TestResult[]
  traces      Trace[]
  logs        Log[]

  @@index([organizationId])
  @@index([createdById])
  @@index([projectId])
  @@index([experimentId])
  @@index([datasetId])
  @@index([status])
  @@index([baselineEvalId])
  @@index([organizationId, status, createdAt])
  @@index([organizationId, createdAt])
  @@index([projectId, createdAt])
}

// Individual test case results
model TestResult {
  id String @id @default(cuid())

  // Test case fields
  input        Json // Can be string or structured object
  expected     Json? // Expected output
  actualOutput Json // Actual output from the system
  context      Json? // Retrieved context for RAG evaluations

  scores Json @default("[]")

  // Aggregate results
  passed       Boolean
  overallScore Float? // 0-1 aggregate score

  // Performance metrics
  latencyMs  Float?
  tokenCount Int? // Total tokens used
  cost       Float? // Cost in USD

  // Error handling
  error     String?
  errorType String? // Classification of error type

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  evalId String
  eval   Eval   @relation(fields: [evalId], references: [id], onDelete: Cascade)

  // Detailed per-metric scores (queryable)
  metricScores MetricScore[]

  @@index([evalId])
  @@index([passed])
  @@index([evalId, passed])
}

// Individual metric scores for queryable filtering (extracted from TestResult.scores)
model MetricScore {
  id         String  @id @default(cuid())
  metricName String // e.g., "hallucination", "answer_relevancy", "toxicity"
  score      Float // Normalized 0-1 score
  passed     Boolean // Did it meet the threshold?
  threshold  Float? // Threshold used for this evaluation
  reason     String? // LLM-as-judge explanation/reasoning

  // Additional metric-specific data
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  testResultId String
  testResult   TestResult @relation(fields: [testResultId], references: [id], onDelete: Cascade)

  @@index([testResultId])
  @@index([metricName])
  @@index([passed])
  @@map("metric_score")
}

enum EvalStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
}

// ===========================================
// TRACE SESSION MODEL
// ===========================================

// Trace sessions group related traces together (e.g., multi-turn conversations)
model TraceSession {
  id        String @id @default(cuid())
  sessionId String // External session ID from SDK

  // User tracking
  userId    String? // External user ID
  userEmail String? // User email for display
  userName  String? // User name for display

  // Session metadata
  metadata Json     @default("{}")
  tags     String[] @default([])

  // Aggregates (updated by triggers/background jobs)
  traceCount    Int   @default(0)
  totalDuration Int   @default(0) // Total duration across all traces (ms)
  totalCost     Float @default(0) // Total cost across all traces (USD)
  totalTokens   Int   @default(0) // Total tokens across all traces

  firstTraceAt DateTime?
  lastTraceAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Belongs to project
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  traces Trace[]

  @@unique([organizationId, sessionId])
  @@index([organizationId])
  @@index([projectId])
  @@index([userId])
  @@index([firstTraceAt])
  @@map("trace_session")
}

// ===========================================
// TRACE MODEL (OpenTelemetry-compatible)
// ===========================================

// OpenTelemetry-compatible traces with enhanced features
model Trace {
  id           String      @id @default(cuid())
  traceId      String      @unique // OpenTelemetry trace ID (32 char hex)
  rootSpanName String
  serviceName  String
  status       TraceStatus @default(UNSET)
  duration     Int // in milliseconds
  spanCount    Int         @default(0)
  startTime    DateTime
  endTime      DateTime?
  createdAt    DateTime    @default(now())

  // Session grouping
  traceSessionId String?
  traceSession   TraceSession? @relation(fields: [traceSessionId], references: [id], onDelete: SetNull)

  // User tracking (can be set independently of session)
  userId       String? // External user ID
  userMetadata Json    @default("{}") // User-related metadata

  // Environment and release tracking
  environment String? // "production", "staging", "development"
  release     String? // Version/release tag

  // Tags for filtering and grouping
  tags String[] @default([])

  // Cost tracking (for LLM operations)
  totalTokens Int? // Total tokens in this trace
  totalCost   Float? // Total cost in USD

  // Direct organization link for tenant isolation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Project link (required for project-scoped traces)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Optional eval link
  evalId String?
  eval   Eval?   @relation(fields: [evalId], references: [id], onDelete: SetNull)

  observations Observation[]
  logs         Log[]

  @@index([organizationId])
  @@index([projectId])
  @@index([traceSessionId])
  @@index([evalId])
  @@index([traceId])
  @@index([startTime])
  @@index([userId])
  @@index([environment])
  @@index([tags])
  @@index([organizationId, startTime])
  @@index([organizationId, status, startTime])
  @@index([projectId, startTime])
  @@index([traceSessionId, startTime])
}

enum TraceStatus {
  OK
  ERROR
  UNSET
}

// ===========================================
// OBSERVATION MODEL (replaces Span)
// ===========================================

// Observations are typed events within a trace: spans, LLM generations, or events
model Observation {
  id           String          @id @default(cuid())
  spanId       String // OpenTelemetry span ID (16 char hex)
  parentSpanId String? // Parent observation for hierarchy
  type         ObservationType @default(SPAN)

  // Common fields
  name          String // Operation name
  startTime     DateTime
  endTime       DateTime?
  duration      Int? // milliseconds
  status        TraceStatus @default(UNSET)
  statusMessage String? // Error message if status is ERROR

  // LLM Generation specific (populated only when type=GENERATION)
  model        String? // e.g., "gpt-4", "claude-3-opus"
  modelParams  Json? // temperature, top_p, max_tokens, etc.
  input        Json? // Prompt/messages (can be string or structured)
  output       Json? // Completion/response
  inputTokens  Int?
  outputTokens Int?
  totalTokens  Int?
  cost         Float? // USD cost for this generation

  // Event specific (when type=EVENT)
  eventName String?

  // OpenTelemetry compatibility
  kind       SpanKind @default(INTERNAL)
  attributes Json     @default("{}")
  events     Json     @default("[]") // Span events (OpenTelemetry)

  // Observation level
  level ObservationLevel @default(DEFAULT)

  // Metadata
  serviceName String?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())

  traceId String
  trace   Trace  @relation(fields: [traceId], references: [id], onDelete: Cascade)

  @@index([traceId])
  @@index([spanId])
  @@index([parentSpanId])
  @@index([type])
  @@index([model])
  @@index([startTime])
  @@map("observation")
}

enum SpanKind {
  INTERNAL
  CLIENT
  SERVER
  PRODUCER
  CONSUMER
}

// Structured logs with trace correlation
model Log {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  level     LogLevel
  source    String // Service/component that generated the log
  agentId   String? // Agent ID for multi-agent systems
  message   String
  metadata  Json     @default("{}")

  // Direct organization link for tenant isolation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Project link (required for project-scoped logs)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Trace correlation (link logs to traces)
  traceId String?
  trace   Trace?  @relation(fields: [traceId], references: [id], onDelete: SetNull)

  // Eval link
  evalId String?
  eval   Eval?   @relation(fields: [evalId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([traceId])
  @@index([evalId])
  @@index([level])
  @@index([source])
  @@index([timestamp])
  @@index([organizationId, timestamp])
  @@index([organizationId, level, timestamp])
  @@index([evalId, timestamp])
}

enum LogLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ===========================================
// COMPLIANCE CHECK MODEL (ABC Framework)
// ===========================================

// Compliance checks for ABC, SOC2, GDPR, EU AI Act
model ComplianceCheck {
  id        String              @id @default(cuid())
  framework ComplianceFramework
  rule      String // Specific rule/requirement being checked
  status    ComplianceStatus    @default(UNCHECKED)
  score     Float? // 0-1 score (if applicable)
  passed    Boolean? // Did it pass the threshold?

  // Evidence and reasoning
  evidence   String? // What was found
  reasoning  String? // Why this status was assigned
  suggestion String? // How to fix/improve

  // What was checked
  entityType String // "eval", "trace", "model", "dataset"
  entityId   String? // ID of the entity checked
  metadata   Json    @default("{}")

  checkedAt DateTime  @default(now())
  expiresAt DateTime? // When this check should be re-run
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Belongs to organization (tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Project link
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@index([framework])
  @@index([status])
  @@index([entityType])
  @@index([checkedAt])
  @@map("compliance_check")
}
